<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Golang å®ç°BTä¸‹è½½å™¨ï¼ˆä¸€ï¼‰ | å¤©åœ°ä¸€é”®</title>

<meta name="keywords" content="Go" />
<meta name="description" content="æœ€è¿‘å‡ å¹´æœ‰åœ¨ä½¿ç”¨PTï¼ˆPrivate Trackerï¼‰ç«™ï¼Œä¸»è¦æ˜¯é«˜æ ¡ç«™ç‚¹ï¼Œè¿‘å‡ å¹´çœ‹çš„å‰§å’Œç”µå½±å‡ ä¹éƒ½æ˜¯åœ¨PTç«™é‡Œä¸‹è½½çš„ï¼Œè™½ç„¶æ ¡å›­ç½‘å¹³æ—¶ä¸Šç½‘å¾ˆæ…¢ï¼Œ">
<meta name="author" content="Me">
<link rel="canonical" href="https://tiandiyijian.top/posts/golang-bt/" />
<meta name="google-site-verification" content="XYZabc" />
<meta name="yandex-verification" content="XYZabc" />
<meta name="msvalidate.01" content="XYZabc" />
<link href="/assets/css/stylesheet.min.746a86b58bb2b052b5e4df8216510494f04f81e62c08d626150c26c69ca929da.css" integrity="sha256-dGqGtYuysFK15N&#43;CFlEElPBPgeYsCNYmFQwmxpypKdo=" rel="preload stylesheet"
    as="style">

<link rel="icon" href="https://s2.loli.net/2022/04/05/vc3QdeULpWlCjbh.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://s2.loli.net/2022/04/05/vc3QdeULpWlCjbh.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://s2.loli.net/2022/04/05/vc3QdeULpWlCjbh.png">
<link rel="apple-touch-icon" href="https://s2.loli.net/2022/04/05/vc3QdeULpWlCjbh.png">
<link rel="mask-icon" href="https://s2.loli.net/2022/04/05/vc3QdeULpWlCjbh.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.97.0-DEV" />


<meta property="og:title" content="Golang å®ç°BTä¸‹è½½å™¨ï¼ˆä¸€ï¼‰" />
<meta property="og:description" content="æœ€è¿‘å‡ å¹´æœ‰åœ¨ä½¿ç”¨PTï¼ˆPrivate Trackerï¼‰ç«™ï¼Œä¸»è¦æ˜¯é«˜æ ¡ç«™ç‚¹ï¼Œè¿‘å‡ å¹´çœ‹çš„å‰§å’Œç”µå½±å‡ ä¹éƒ½æ˜¯åœ¨PTç«™é‡Œä¸‹è½½çš„ï¼Œè™½ç„¶æ ¡å›­ç½‘å¹³æ—¶ä¸Šç½‘å¾ˆæ…¢ï¼Œ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://tiandiyijian.top/posts/golang-bt/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-30T08:40:57&#43;08:00" />
<meta property="article:modified_time" content="2022-08-30T08:40:57&#43;08:00" /><meta property="og:site_name" content="ExampleSite" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Golang å®ç°BTä¸‹è½½å™¨ï¼ˆä¸€ï¼‰"/>
<meta name="twitter:description" content="æœ€è¿‘å‡ å¹´æœ‰åœ¨ä½¿ç”¨PTï¼ˆPrivate Trackerï¼‰ç«™ï¼Œä¸»è¦æ˜¯é«˜æ ¡ç«™ç‚¹ï¼Œè¿‘å‡ å¹´çœ‹çš„å‰§å’Œç”µå½±å‡ ä¹éƒ½æ˜¯åœ¨PTç«™é‡Œä¸‹è½½çš„ï¼Œè™½ç„¶æ ¡å›­ç½‘å¹³æ—¶ä¸Šç½‘å¾ˆæ…¢ï¼Œ"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://tiandiyijian.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Golang å®ç°BTä¸‹è½½å™¨ï¼ˆä¸€ï¼‰",
      "item": "https://tiandiyijian.top/posts/golang-bt/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Golang å®ç°BTä¸‹è½½å™¨ï¼ˆä¸€ï¼‰",
  "name": "Golang å®ç°BTä¸‹è½½å™¨ï¼ˆä¸€ï¼‰",
  "description": "æœ€è¿‘å‡ å¹´æœ‰åœ¨ä½¿ç”¨PTï¼ˆPrivate Trackerï¼‰ç«™ï¼Œä¸»è¦æ˜¯é«˜æ ¡ç«™ç‚¹ï¼Œè¿‘å‡ å¹´çœ‹çš„å‰§å’Œç”µå½±å‡ ä¹éƒ½æ˜¯åœ¨PTç«™é‡Œä¸‹è½½çš„ï¼Œè™½ç„¶æ ¡å›­ç½‘å¹³æ—¶ä¸Šç½‘å¾ˆæ…¢ï¼Œ",
  "keywords": [
    "Go"
  ],
  "articleBody": "æœ€è¿‘å‡ å¹´æœ‰åœ¨ä½¿ç”¨PTï¼ˆPrivate Trackerï¼‰ç«™ï¼Œä¸»è¦æ˜¯é«˜æ ¡ç«™ç‚¹ï¼Œè¿‘å‡ å¹´çœ‹çš„å‰§å’Œç”µå½±å‡ ä¹éƒ½æ˜¯åœ¨PTç«™é‡Œä¸‹è½½çš„ï¼Œè™½ç„¶æ ¡å›­ç½‘å¹³æ—¶ä¸Šç½‘å¾ˆæ…¢ï¼Œä½†æ˜¯ipv6é€Ÿåº¦è¿˜æ˜¯å¾ˆå¿«çš„ã€‚å‰ä¸€é˜µå­çªç„¶å¥½å¥‡BTä¸‹è½½çš„åŸç†å…·ä½“æ˜¯å•¥ï¼Œèƒ½ä¸èƒ½ç”¨Goè¯­è¨€å®ç°BTä¸‹è½½å™¨ï¼Œåœ¨ç½‘ä¸Šæœäº†ä¸€ä¸‹å‘ç°è¿˜çœŸæœ‰äººåšäº†ï¼Œäºæ˜¯è‡ªå·±å­¦ä¹ å®ç°äº†ä¸€ä¸‹ã€‚\nä»€ä¹ˆæ˜¯BT BTï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å˜æ€ï¼Œæ˜¯ BitTorrentï¼ˆæ¯”ç‰¹æ´ªæµï¼‰çš„ç®€ç§°ã€‚BitTorrent æ˜¯ä¸€ç§ P2Pï¼ˆpeer-to-peerï¼‰åè®®ï¼ŒBitTorrent ç½‘ç»œä¸­çš„ç”¨æˆ·è¢«ç§°ä½œ peerï¼Œæ¯ä¸ª peer éƒ½æ˜¯å‘åˆ«çš„ peer è¯·æ±‚èµ„æºï¼Œå³ peer åœ¨ä¸‹è½½çš„åŒæ—¶ä¹Ÿæ‹¥æœ‰ä¸Šä¼ çš„èƒ½åŠ›ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ç”¨æˆ·è¶Šå¤šï¼Œä¸‹è½½åŒä¸€æ–‡ä»¶çš„äººè¶Šå¤šï¼Œä¸‹è½½è¯¥æ–‡ä»¶çš„é€Ÿåº¦è¶Šå¿«ï¼Œä¸ä¼ ç»Ÿçš„C/Sæ¨¡å¼ä¸­æ‰€æœ‰çš„ç”¨æˆ·åªèƒ½å‘åŒä¸€ä¸ªæœåŠ¡å™¨è¯·æ±‚èµ„æºæ˜æ˜¾ä¸åŒã€‚\nè·å– Peers ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ€ä¹ˆå‘ç°åˆ«çš„ peersï¼Œè¿™å°±æ˜¯ tracker çš„ä½œç”¨ï¼Œæ ¹æ®ç»´åŸºç™¾ç§‘å®šä¹‰ï¼Œtracker æ˜¯æ”¶é›†ä¸‹è½½è€…ä¿¡æ¯çš„æœåŠ¡å™¨ï¼Œå¹¶å°†æ­¤ä¿¡æ¯æä¾›ç»™å…¶ä»–ä¸‹è½½è€…ï¼Œä½¿ä¸‹è½½è€…ä»¬ç›¸äº’è¿æ¥èµ·æ¥ï¼Œä¼ è¾“æ•°æ®ã€‚é‚£ä¹ˆ tracker åˆåœ¨å“ªå‘¢ï¼Ÿè¿™å°±æ˜¯ .torrent æ–‡ä»¶çš„ä½œç”¨ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æŠŠ .torrent æ–‡ä»¶å«åšç§å­æ–‡ä»¶ï¼Œä½†å…¶å® torrent çš„ä¸­æ–‡æ„æ€æ˜¯æ´ªæµï¼ŒæŠŠé€šè¿‡ä¸€ä¸ª tracker æœåŠ¡å™¨è¿æ¥èµ·æ¥çš„ peers ç½‘ç»œç§°ä½œä¸€ä¸ªæ´ªæµï¼Œè¿˜æŒºå½¢è±¡çš„ã€‚\nè§£æ .torrent æ–‡ä»¶ .torrent æ–‡ä»¶ä½¿ç”¨ Bencodeï¼ˆå‘éŸ³ä¸ºÂ bee-encodeï¼‰è¿›è¡Œäº†ç¼–ç ã€‚Bencode ä½¿ç”¨ ASCII å­—ç¬¦è¿›è¡Œç¼–ç ï¼š\n  Integer ç¼–ç ä¸º ieï¼Œå¦‚ i7e è¡¨ç¤ºæ•´æ•° 7\n  Byte string ç¼–ç ä¸º :ï¼Œå¦‚ 4:spam è¡¨ç¤ºå­—ç¬¦ä¸² â€œspamâ€\n  List ç¼–ç ä¸º leï¼Œå¦‚ l4:spam4:eggse è¡¨ç¤º [\"spam\", \"eggs\"]ï¼Œlist å¯ä»¥åŒ…å«ä»»ä½•å…¶ä»–ç±»å‹çš„ bencoded value\n  Dictionary ç¼–ç ä¸º deï¼Œå¦‚ d3:cow3:moo4:spam4:eggse è¡¨ç¤ºå­—å…¸ï¼š{ \"cow\" : \"moo\", \"spam\" : \"eggs\" }\n  å¦‚æ–‡ä»¶ debian-11.4.0-amd64-netinst.iso.torrent çš„å†…å®¹ä¸ºï¼š\n1  d8:announce41:http://bttracker.debian.org:6969/announce7:comment35:\"Debian CD from cdimage.debian.org\"13:creation datei1657367679e9:httpseedsl145:https://cdimage.debian.org/cdimage/release/11.4.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-11.4.0-amd64-netinst.iso145:https://cdimage.debian.org/cdimage/archive/11.4.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-11.4.0-amd64-netinst.isoe4:infod6:lengthi397410304e4:name31:debian-11.4.0-amd64-netinst.iso12:piece lengthi262144e6:pieces30320:(binary blob of the hashes of each piece)   æŠŠå®ƒè½¬æ¢æˆæ›´å¥½çœ‹çš„å½¢å¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  d  8:announce  41:http://bttracker.debian.org:6969/announce  7:comment  35:\"Debian CD from cdimage.debian.org\"  13:creation date  i1657367679e  9:httpseeds Â l Â 145:https://cdimage.debian.org/cdimage/release/11.4.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-11.4.0-amd64-netinst.iso Â 145:https://cdimage.debian.org/cdimage/archive/11.4.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-11.4.0-amd64-netinst.iso Â e  4:info  d  6:length  i351272960e  4:name  31:debian-10.2.0-amd64-netinst.iso  12:piece length  i262144e  6:pieces  26800:ï¿½\u001fï¿½\u000fï¿½ï¿½ï¿½PSï¿½^ï¿½ï¿½ (binary blob of the hashes of each piece)  e e   è¿™ä¸ªæ–‡ä»¶ä¸­åŒ…æ‹¬ tracker çš„ URLã€åˆ›å»ºæ—¶é—´ã€æ–‡ä»¶çš„å¤§å°å’Œåç§°ã€piece çš„å¤§å°ä»¥åŠæ‰€æœ‰ piece çš„ SHA-1 å“ˆå¸Œå€¼çš„ BLOB ï¼ˆbinary large objectï¼‰ã€‚httpseeds å­—æ®µæ˜¯åç»­ä¸ºäº†æ”¯æŒé€šè¿‡ HTTP åè®®åˆ†å‘æ•°æ®çš„æ‹“å±•ï¼Œæœ¬æ–‡ä¸ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œå¯ä»¥ç›´æ¥å¿½ç•¥ã€‚\nå®ç° BencodeÂ è§£æå™¨ æ‰€ä»¥è¦è§£æ .torrent æ–‡ä»¶å°±éœ€è¦ä¸€ä¸ª bencode è§£æå™¨ï¼Œç½‘ä¸Šå·²ç»æœ‰ç°æˆçš„äº†ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰å†™è¿‡è¿™ç§è§£æå™¨ï¼Œæ‰€ä»¥å°±å‚è€ƒè¿™ä¸ªé¡¹ç›®å†™äº†ä¸€ä¸ªã€‚\né¦–å…ˆå®šä¹‰ä»¥ä¸‹å†…å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  type BType uint8 type BVal interface{}  const (  BINT BType = iota  BSTR  BLIST  BDICT )  type BObj struct {  type_ BType  val_ BVal }   æŠŠä»»æ„ bencode ç¼–ç çš„å¯¹è±¡è¡¨ç¤ºä¸ºä¸€ä¸ª BObjï¼Œå®ƒæœ‰ç±»å‹å’Œå€¼ä¸¤ä¸ªå­—æ®µï¼Œåˆå› ä¸ºå…·ä½“å€¼çš„ç±»å‹æ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥ä½¿ç”¨ç©ºæ¥å£ç±»å‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75  func Decode(r io.Reader) (*BObj, error) {  br, ok := r.(*bufio.Reader)  if !ok {  br = bufio.NewReader(r)  }   b, err := br.Peek(1)  if err != nil {  return nil, err  }   switch {  case b[0] = '0' \u0026\u0026 b[0] '9':  s, err := DecodeString(br)  if err != nil {  return nil, err  }   return NewBObj(BSTR, s), nil  case b[0] == 'i':  num, err := DecodeInt(br)  if err != nil {  return nil, err  }   return NewBObj(BINT, num), nil  case b[0] == 'l':  br.ReadByte() // start l  var list []*BObj  for {  b, err := br.Peek(1)  if err != nil {  return nil, err  }   if b[0] == 'e' { // end e  br.ReadByte()  return NewBObj(BLIST, list), nil  }   bobj, err := Decode(br)  if err != nil {  return nil, err  }  list = append(list, bobj)  }  case b[0] == 'd':  br.ReadByte() // start d  dict := map[string]*BObj{}  for {  b, err := br.Peek(1)  if err != nil {  return nil, err  }   if b[0] == 'e' { // end e  br.ReadByte()  return NewBObj(BDICT, dict), nil  }   key, err := DecodeString(br)  if err != nil {  return nil, err  }   bobj, err := Decode(br)  if err != nil {  return nil, err  }  dict[key] = bobj  }  }   return nil, ErrIvd }   è§£ç å‡½æ•°æ€è·¯æ˜¯é¦–å…ˆæ ¹æ®å¼€å¤´åˆ¤æ–­æ•°æ®ç±»å‹ï¼Œç„¶åå»è§£æï¼Œå¦‚æœæ˜¯ List æˆ– Dictionary ç±»å‹ç›´æ¥å¾ªç¯é€’å½’å¤„ç†å°±è¡Œäº†ï¼Œåœ¨å¾ªç¯ä¸­æ£€æŸ¥ä¸‹ä¸€ä¸ªå¾…è¯»å–çš„å­—ç¬¦æ˜¯ä¸æ˜¯ â€™eâ€™ ï¼Œå¦‚æœæ˜¯çš„è¯é‚£ä¹ˆä¸€å®šæ˜¯è¯¥ BObj æœ€åä¸€ä¸ª â€™eâ€™ï¼Œå› ä¸ºå®ƒåµŒå¥—çš„ BObj ä¸€å®šä¼šæŠŠå‰é¢çš„ â€™eâ€™ï¼ˆå¦‚æœæœ‰çš„è¯ï¼Œå½“åµŒå¥—äº† List å’Œ Dictionary å’Œ Integer ç±»å‹æ—¶ä¼šæœ‰ï¼‰è¯»å–å‡ºæ¥ ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68  func (o *BObj) Encode(w io.Writer) (int, error) {  bw, ok := w.(*bufio.Writer)  if !ok {  bw = bufio.NewWriter(w)  }   curLen := 0  switch o.type_ {  case BINT:  num, _ := o.Int()  wLen, err := EncodeInt(bw, num)  if err != nil {  return 0, err  }  curLen += wLen  case BSTR:  s, _ := o.Str()  wLen, err := EncodeStr(bw, s)  if err != nil {  return 0, err  }  curLen += wLen  case BLIST:  list, _ := o.List()   curLen += 1  bw.WriteByte('l')   for _, bobj := range list {  wLen, err := bobj.Encode(bw)  if err != nil {  return 0, err  }  curLen += wLen  }   curLen += 1  bw.WriteByte('e')  case BDICT:  dict, _ := o.Dict()   curLen += 1  bw.WriteByte('d')   for key, bobj := range dict {  wLen, err := EncodeStr(bw, key)  if err != nil {  return 0, err  }  curLen += wLen   wLen, err = bobj.Encode(bw)  if err != nil {  return 0, err  }  curLen += wLen  }   curLen += 1  bw.WriteByte('e')  }   if err := bw.Flush(); err != nil {  return 0, err  }   return curLen, nil }   ç¼–ç å‡½æ•°æ€è·¯å’Œè§£ç å‡½æ•°å·®ä¸å¤šï¼Œç›´æ¥åˆ¤æ–­ BObj çš„ç±»å‹ç„¶åå»ç¼–ç ï¼Œå¦‚æœæ˜¯ List æˆ– Dictionary ç±»å‹åŒæ ·å»å¾ªç¯é€’å½’å¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  func Unmarshal(r io.Reader, s interface{}) error {  o, err := Decode(r)  if err != nil {  return err  }   v := reflect.ValueOf(s)  if v.Kind() != reflect.Ptr {  return errors.New(\"dst must be a pointer\")  }   switch o.type_ {  case BLIST:  list, _ := o.List()  l := reflect.MakeSlice(v.Elem().Type(), len(list), len(list))  v.Elem().Set(l)  err = unmarshalList(list, v)  if err != nil {  return err  }  case BDICT:  dict, _ := o.Dict()  err := unmarshalDict(dict, v)  if err != nil {  return err  }  default:  return errors.New(\"src must be struct or slice\")  }   return err }   Unmarshal å‡½æ•°é¦–å…ˆåˆ©ç”¨ä¹‹å‰çš„è§£ç å‡½æ•°å¾—åˆ°ä¸€ä¸ª BObjï¼Œ ç„¶ååˆ©ç”¨è¿™ä¸ª BObj å»ååºåˆ—åŒ–ã€‚ååºåˆ—åŒ–çš„ç›®æ ‡åªèƒ½æ˜¯åˆ‡ç‰‡æˆ–è€…ç»“æ„ä½“ç±»å‹ï¼Œè¾“å…¥æ˜¯å®ƒä»¬çš„æŒ‡é’ˆã€‚å¦‚æœæ˜¯ List çš„è¯è¦å…ˆåˆ©ç”¨åå°„æŠŠåˆ‡ç‰‡çš„é•¿åº¦è®¾ç½®å¥½ã€‚é‡ç‚¹æ˜¯ unmarshalList å’Œ UnmarshalDict è¿™ä¸¤ä¸ªå‡½æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67  func unmarshalList(list []*BObj, v reflect.Value) error {  if v.Kind() != reflect.Ptr || v.Elem().Kind() != reflect.Slice {  return errors.New(\"dst must be pointer of slice\")  }   v = v.Elem()  if len(list) == 0 {  return nil  }   switch list[0].type_ {  case BSTR:  for i, bObj := range list {  s, err := bObj.Str()  if err != nil {  return err  }  v.Index(i).SetString(s)  }  case BINT:  for i, bObj := range list {  num, err := bObj.Int()  if err != nil {  return err  }  v.Index(i).SetInt(int64(num))  }  case BLIST:  if v.Type().Elem().Kind() != reflect.Slice {  return ErrTyp  }  for i, bObj := range list {  bList, err := bObj.List()  if err != nil {  return err  }   newPtr := reflect.New(v.Type().Elem())  newSlice := reflect.MakeSlice(v.Type().Elem(), len(bList), len(bList))  newPtr.Elem().Set(newSlice)  err = unmarshalList(bList, newPtr)  if err != nil {  return err  }  v.Index(i).Set(newPtr.Elem())  }  case BDICT:  if v.Type().Elem().Kind() != reflect.Struct {  return ErrTyp  }  for i, bObj := range list {  bDict, err := bObj.Dict()  if err != nil {  return err  }   newPtr := reflect.New(v.Type().Elem())  err = unmarshalDict(bDict, newPtr)  if err != nil {  return err  }  v.Index(i).Set(newPtr.Elem())  }  }   return nil }   unmarshalList å‡½æ•°é¦–å…ˆåˆ¤æ–­è¾“å…¥çš„ v åªèƒ½æ˜¯åˆ‡ç‰‡çš„æŒ‡é’ˆç±»å‹ï¼Œè¦ä¸ç„¶ä¸èƒ½ Setã€‚è¾“å…¥ list ä¸­çš„å…ƒç´ çš„ç±»å‹è‚¯å®šéƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¯¹åº”åˆ‡ç‰‡ä¸­å…ƒç´ çš„ç±»å‹ï¼Œæ‰€ä»¥åªåˆ¤æ–­ç¬¬ä¸€ä¸ªå…ƒç´ çš„ç±»å‹å°±å¯ä»¥äº†ï¼Œç„¶åå»å¾ªç¯è®¾ç½®æ¯ä¸€ä¸ªä½ç½®çš„å…ƒç´ ã€‚æ•´æ•°å’Œå­—ç¬¦ä¸²çš„æƒ…å†µæ¯”è¾ƒç®€å•ï¼Œä¸å†èµ˜è¿°ã€‚\nå¯¹äº BLIST ç±»å‹ï¼Œå…ˆåˆ¤æ–­è¾“å…¥ v çš„ç±»å‹çš„çš„åŸºæœ¬å…ƒç´ ï¼ˆv.Type().Elem() çš„è¿”å›å€¼ä¹Ÿæ˜¯ reflect.Type ç±»å‹ï¼ŒæŒ‡çš„æ˜¯å½“å‰ç±»å‹çš„åŸºæœ¬å…ƒç´ ç±»å‹ï¼Œåªé’ˆå¯¹æŒ‡é’ˆã€æ•°ç»„ã€åˆ‡ç‰‡ã€æ˜ å°„ã€é€šé“ç±»å‹æ‰æ˜¯æœ‰æ•ˆçš„ï¼Œè¦å’Œ v.Elem() åŒºåˆ†å¼€ï¼Œè¯¥å‡½æ•°çš„è¿”å›å€¼ç±»å‹æ˜¯ reflect.Valueï¼Œåªé’ˆå¯¹æŒ‡é’ˆå’Œæ¥å£ç±»å‹æ‰æœ‰æ•ˆï¼ŒæŒ‡çš„å°±æ˜¯ v æŒ‡å‘çš„å€¼ï¼‰ä¹Ÿæ˜¯åˆ‡ç‰‡ç±»å‹æ‰å¯ä»¥æ­£ç¡®è¿›è¡Œååºåˆ—åŒ–ã€‚åˆ¤æ–­å®Œæˆä¹‹åå†å»å¾ªç¯è®¾ç½®ï¼Œæ¯ä¸€æ¬¡å¾ªç¯éƒ½å…ˆè·å–åˆ°å½“å‰ä½ç½®å¯¹åº”çš„ bList ç„¶ååˆ›å»ºä¸€ä¸ªåˆ‡ç‰‡çš„æŒ‡é’ˆï¼Œè®¾ç½®å…¶é•¿åº¦å’Œå®¹é‡ï¼Œå†è¿›è¡Œé€’å½’å¤„ç†ã€‚æœ€åè®¾ç½®è¯¥ä½ç½®çš„å…ƒç´ ã€‚\nå¯¹äº BDICT ç±»å‹ï¼Œè¿‡ç¨‹å’Œ BLIST ç±»å‹ç±»ä¼¼ã€‚unmarshalDict å‡½æ•°å’Œ unmarshalList åŸºæœ¬ä¸€è‡´ï¼Œåªä¸è¿‡å› ä¸ºæ¯ä¸€ä¸ªå­—æ®µçš„ç±»å‹å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥è¦åœ¨æ¯ä¸€æ¬¡å¾ªç¯é‡Œé¢åˆ¤æ–­ç±»å‹ã€‚å¦å¤–å°±æ˜¯ tag çš„å¤„ç†ï¼Œè¿‡ç¨‹ä¹Ÿæ¯”è¾ƒç®€å•ï¼š\n1 2 3 4 5 6 7  fieldType := v.Type().Field(i) key := fieldType.Tag.Get(\"bencode\") if key == \"\" {  key = strings.ToLower(fieldType.Name) }  bObj, ok := bDict[key]   Marshal å‡½æ•°å°±æ¯”è¾ƒç®€å•äº†ï¼Œç›´æ¥åˆ¤æ–­å½“å‰å€¼çš„ç±»å‹ç„¶åå»ç¼–ç å°±è¡Œäº†ï¼Œè¿‡ç¨‹è·Ÿç¼–ç å‡½æ•°åŸºæœ¬ä¸€è‡´ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92  func Marshal(w io.Writer, i interface{}) (int, error) {  v := reflect.ValueOf(i)  if v.Kind() == reflect.Ptr {  v = v.Elem()  }  return marshalValue(w, v) }  func marshalValue(w io.Writer, v reflect.Value) (int, error) {  curLen := 0  switch v.Kind() {  case reflect.Int:  wLen, err := EncodeInt(w, int(v.Int()))  if err != nil {  return 0, err  }   curLen += wLen  case reflect.String:  wLen, err := EncodeStr(w, v.String())  if err != nil {  return 0, err  }   curLen += wLen  case reflect.Slice:  wLen, err := marshalList(w, v)  if err != nil {  return 0, err  }   curLen += wLen  case reflect.Struct:  wLen, err := marshalDict(w, v)  if err != nil {  return 0, err  }   curLen += wLen  default:  return 0, errors.New(\"unsupported type\")  }   return curLen, nil }  func marshalList(w io.Writer, v reflect.Value) (int, error) {  curLen := 1  w.Write([]byte{'l'})   for i := 0; i  curV := v.Index(i)  wLen, err := marshalValue(w, curV)  if err != nil {  return 0, err  }  curLen += wLen  }   w.Write([]byte{'e'})  return curLen + 1, nil }  func marshalDict(w io.Writer, v reflect.Value) (int, error) {  curLen := 1  w.Write([]byte{'d'})   for i := 0; i  field := v.Field(i)  fieldType := v.Type().Field(i)   key := fieldType.Tag.Get(\"bencode\")  if key == \"\" {  key = strings.ToLower(fieldType.Name)  }   wLen, err := EncodeStr(w, key)  if err != nil {  return 0, err  }  curLen += wLen   wLen, err = marshalValue(w, field)  if err != nil {  return 0, err  }  curLen += wLen  }   w.Write([]byte{'e'})  return curLen + 1, nil }   ä½¿ç”¨ bencode è§£æå™¨è§£æ .torrent æ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  type Info struct {  Length int `bencode:\"length\"`  Name string `bencode:\"name\"`  PieceLength int `bencode:\"piece length\"`  Pieces string `bencode:\"pieces\"` }  type TorrentFile struct {  Announce string `bencode:\"announce\"`  Info Info `bencode:\"info\"` }  var tf torrentfile.TorrentFile file, _ := os.Open(\"xxx.torrent\") err := bencode.Unmarshal(file, \u0026tf) if err != nil {  log.Fatalln(\"invalid torrent file\") }   ä»¥ä¸Šå°±å®Œæˆäº† .torrent æ–‡ä»¶çš„è§£æ\nä» tracker è·å– peers é¦–å…ˆå®šä¹‰ä¸€ä¸ªæ–°çš„ç»“æ„ä½“ï¼Œä¸åºåˆ—åŒ–ç»“æ„ä½“åŒºåˆ†å¼€ï¼Œä½œä¸ºåº”ç”¨ç»“æ„ä½“ï¼š\n1 2 3 4 5 6 7 8 9 10  type Torrent struct {  Announce string  Name string  Length int  InfoHash [20]byte  PieceLength int  PieceHashes [][20]byte  Peers []peer.Peer  PeerID [20]byte }   TorrentFile å®ç°å‘ Torrent è½¬æ¢çš„æ–¹æ³• ToTorrentï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47  func (i *Info) Hash() ([20]byte, error) { \tvar buf bytes.Buffer \t_, err := bencode.Marshal(\u0026buf, *i) \tif err != nil { \treturn [20]byte{}, err \t} \th := sha1.Sum(buf.Bytes()) \treturn h, nil }  func (i *Info) splitPieceHashes() ([][20]byte, error) { \thashLen := 20 \tbuf := []byte(i.Pieces) \tif len(buf)%hashLen != 0 { \treturn nil, fmt.Errorf(\"malformed pieces hash length: %d\", len(buf)) \t}  \tnumHashes := len(buf) / hashLen \thashes := make([][20]byte, numHashes)  \tfor i := 0; i \tcopy(hashes[i][:], buf[i*hashLen:(i+1)*hashLen]) \t}  \treturn hashes, nil }  func (tf *TorrentFile) ToTorrent() (torrent.Torrent, error) { \tinfoHash, err := tf.Info.Hash() \tif err != nil { \treturn torrent.Torrent{}, err \t}  \tpieceHashes, err := tf.Info.splitPieceHashes() \tif err != nil { \treturn torrent.Torrent{}, err \t}  \treturn torrent.Torrent{ \tAnnounce: tf.Announce, \tName: tf.Info.Name, \tLength: tf.Info.Length, \tInfoHash: infoHash, \tPieceLength: tf.Info.PieceLength, \tPieceHashes: pieceHashes, \t}, nil }   Torrent è·å– Peers çš„æ–¹æ³•ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53  type TrackerResp struct { \tInterval int `bencode:\"interval\"` \tPeers string `bencode:\"peers\"` }  func (t *Torrent) buildTrackerURL(peerID [20]byte, port uint16) (string, error) { \tbase, err := url.Parse(t.Announce) \tif err != nil { \treturn \"\", err \t} \tparams := url.Values{ \t\"info_hash\": []string{string(t.InfoHash[:])}, \t\"peer_id\": []string{string(peerID[:])}, \t\"port\": []string{strconv.Itoa(int(Port))}, \t\"uploaded\": []string{\"0\"}, \t\"downloaded\": []string{\"0\"}, \t\"compact\": []string{\"1\"}, \t\"left\": []string{strconv.Itoa(t.Length)}, \t} \tbase.RawQuery = params.Encode() \treturn base.String(), nil }  func (t *Torrent) GetPeers() error { \t_, err := rand.Read(t.PeerID[:]) \tif err != nil { \treturn err \t}  \turl, err := t.buildTrackerURL(t.PeerID, uint16(Port))  \tc := \u0026http.Client{Timeout: 15 * time.Second} \tresp, err := c.Get(url) \tif err != nil { \treturn err \t} \tdefer resp.Body.Close()  \tres, err := io.ReadAll(resp.Body) \tvar tr TrackerResp \terr = bencode.Unmarshal(bytes.NewBuffer(res), \u0026tr) \tif err != nil { \treturn err \t}  \tpeers, err := peer.Unmarshal([]byte(tr.Peers)) \tif err != nil { \treturn err \t}  \tt.Peers = peers \treturn nil }   åœ¨å‘ tracker è¯·æ±‚çš„å‚æ•°ä¸­ï¼š\n  info_hashï¼š.torrent æ–‡ä»¶ä¸­ info éƒ¨åˆ†çš„ SHA-1 å“ˆå¸Œå€¼ï¼Œtracker ç”¨è¿™ä¸ªç¡®è®¤æƒ³è¦ä¸‹è½½å“ªä¸ªæ–‡ä»¶ï¼Œè¿™æ ·æ‰èƒ½ç¡®è®¤æ‹¥æœ‰è¿™ä¸ªæ–‡ä»¶çš„ peers\n  peer_idï¼šå®¢æˆ·ç«¯çš„ IDï¼Œå¦‚â€utorrent-xxxâ€œï¼Œæ ‡è¯†å®¢æˆ·ç«¯è½¯ä»¶å’Œç‰ˆæœ¬ï¼Œæœ¬æ–‡ç›´æ¥ç”¨éšæœºç”Ÿæˆçš„\n  portï¼šå®¢æˆ·ç«¯ç›‘å¬çš„ç«¯å£å·\n  uploadedï¼šæ€»ä¸Šä¼ é‡\n  downloadedï¼šæ€»ä¸‹è½½é‡\n  compactï¼šè®¾ä¸º 1 è¡¨ç¤ºä½¿ç”¨ç´§å‡‘æ¨¡å¼ï¼Œæ¯ä¸ª peer ç”¨å…­ä¸ªå­—èŠ‚è¡¨ç¤ºï¼Œå‰å››ä¸ªæ˜¯ IP åœ°å€åä¸¤ä¸ªæ˜¯ç«¯å£å·\n  leftï¼šå‰©ä½™ä¸‹è½½é‡\n  Tracker å‘å›çš„å“åº”ä¹Ÿæ˜¯ bencode ç¼–ç çš„æ ¼å¼ï¼Œå¯ä»¥ç”¨ä¸Šæ–‡å®ç°çš„ bencode è§£æå™¨ç›´æ¥ååºåˆ—åŒ–å¾—åˆ° TrackerResp ç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸¤ä¸ªå­—æ®µï¼šInterval è¡¨ç¤ºåº”è¯¥éš”å¤šä¹…å†æ¬¡è¿æ¥åˆ° tracker æ¥æ›´æ–° peers åˆ—è¡¨ï¼ŒPeers æ˜¯ä¸€ä¸ªåŒ…å«ä¸Šæ–‡æåˆ°çš„ 6 å­—èŠ‚åœ°å€çš„ BLOBï¼Œå®šä¹‰ Peer ç»“æ„ä½“æ¥è§£æå®ƒï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  type Peer struct { \tIP net.IP \tPort uint16 }  func Unmarshal(peersBin []byte) ([]Peer, error) { \tconst peerSize = 6 // 4 for ip, 2 for port \tif len(peersBin)%peerSize != 0 { \treturn nil, fmt.Errorf(\"malformed binary peers length: %d\", len(peersBin)) \t}  \tnumPeers := len(peersBin) / peerSize \tpeers := make([]Peer, numPeers) \tfor i := 0; i \toffset := i * peerSize \t//peers[i].IP = net.IP(peersBin[offset : offset+4]) \tpeers[i].IP = peersBin[offset : offset+4] \tpeers[i].Port = binary.BigEndian.Uint16(peersBin[offset+4 : offset+6]) \t}  \treturn peers, nil }   åˆ°æ­¤ï¼Œå·²ç»è·å–åˆ°äº†æ‹¥æœ‰ .torrent ä¸­æ–‡ä»¶çš„ peersã€‚\n",
  "wordCount" : "4148",
  "inLanguage": "en",
  "datePublished": "2022-08-30T08:40:57+08:00",
  "dateModified": "2022-08-30T08:40:57+08:00",
  "author":{
    "@type": "Person",
    "name": "Me"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://tiandiyijian.top/posts/golang-bt/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "å¤©åœ°ä¸€é”®",
    "logo": {
      "@type": "ImageObject",
      "url": "https://s2.loli.net/2022/04/05/vc3QdeULpWlCjbh.png"
    }
  }
}
</script>





</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }
    </style>

</noscript>
<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://tiandiyijian.top" accesskey="h" title="å¤©åœ°ä¸€é”® (Alt + H)">å¤©åœ°ä¸€é”®</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                
                
            </span>
        </div>
        <ul id="menu" onscroll="menu_on_scroll()">
            <li>
                <a href="https://tiandiyijian.top/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://tiandiyijian.top/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://tiandiyijian.top/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://tiandiyijian.top/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li></ul>
    </nav>
</header>

    <main class="main">

<article class="post-single">
  <header class="post-header">
<div class="breadcrumbs">

    <a href="https://tiandiyijian.top">Home</a>&nbsp;Â»&nbsp;<a href="https://tiandiyijian.top/posts/">Posts</a>
</div>

    <h1 class="post-title">
      Golang å®ç°BTä¸‹è½½å™¨ï¼ˆä¸€ï¼‰
    </h1>
    <div class="post-meta">

August 30, 2022&nbsp;Â·&nbsp;9 min&nbsp;Â·&nbsp;Me

|&nbsp;<a href="https://github.com/%3cpath_to_repo%3e/content/posts%5cGolang-BT.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>
</div>
  </header> 

  <div class="toc">
    <details >
      <summary accesskey="c" title="(Alt + C)">
        <div class="details">Table of Contents</div>
      </summary>
      <div class="inner"><ul><li>
        <a href="#%e4%bb%80%e4%b9%88%e6%98%afbt" aria-label="ä»€ä¹ˆæ˜¯BT">ä»€ä¹ˆæ˜¯BT</a></li><li>
        <a href="#%e8%8e%b7%e5%8f%96-peers" aria-label="è·å– Peers">è·å– Peers</a><ul>
            <li>
        <a href="#%e8%a7%a3%e6%9e%90-torrent-%e6%96%87%e4%bb%b6" aria-label="è§£æ .torrent æ–‡ä»¶">è§£æ .torrent æ–‡ä»¶</a><ul>
            <li>
        <a href="#%e5%ae%9e%e7%8e%b0-bencode%e8%a7%a3%e6%9e%90%e5%99%a8" aria-label="å®ç° BencodeÂ è§£æå™¨">å®ç° BencodeÂ è§£æå™¨</a></li><li>
        <a href="#%e4%bd%bf%e7%94%a8-bencode-%e8%a7%a3%e6%9e%90%e5%99%a8%e8%a7%a3%e6%9e%90-torrent-%e6%96%87%e4%bb%b6" aria-label="ä½¿ç”¨ bencode è§£æå™¨è§£æ .torrent æ–‡ä»¶">ä½¿ç”¨ bencode è§£æå™¨è§£æ .torrent æ–‡ä»¶</a></li></ul>
    </li><li>
        <a href="#%e4%bb%8e-tracker-%e8%8e%b7%e5%8f%96-peers" aria-label="ä» tracker è·å– peers">ä» tracker è·å– peers</a></li></ul>
</li></ul>
      </div>
    </details>
  </div>
  <div class="post-content">
<p>æœ€è¿‘å‡ å¹´æœ‰åœ¨ä½¿ç”¨PTï¼ˆPrivate Trackerï¼‰ç«™ï¼Œä¸»è¦æ˜¯é«˜æ ¡ç«™ç‚¹ï¼Œè¿‘å‡ å¹´çœ‹çš„å‰§å’Œç”µå½±å‡ ä¹éƒ½æ˜¯åœ¨PTç«™é‡Œä¸‹è½½çš„ï¼Œè™½ç„¶æ ¡å›­ç½‘å¹³æ—¶ä¸Šç½‘å¾ˆæ…¢ï¼Œä½†æ˜¯ipv6é€Ÿåº¦è¿˜æ˜¯å¾ˆå¿«çš„ã€‚å‰ä¸€é˜µå­çªç„¶å¥½å¥‡BTä¸‹è½½çš„åŸç†å…·ä½“æ˜¯å•¥ï¼Œèƒ½ä¸èƒ½ç”¨Goè¯­è¨€å®ç°BTä¸‹è½½å™¨ï¼Œåœ¨ç½‘ä¸Šæœäº†ä¸€ä¸‹å‘ç°è¿˜çœŸæœ‰äººåšäº†ï¼Œäºæ˜¯è‡ªå·±å­¦ä¹ å®ç°äº†ä¸€ä¸‹ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯bt">ä»€ä¹ˆæ˜¯BT<a hidden class="anchor" aria-hidden="true" href="#ä»€ä¹ˆæ˜¯bt">#</a></h2>
<p>BTï¼Œé¡¾åæ€ä¹‰ï¼Œ<del>å°±æ˜¯å˜æ€</del>ï¼Œæ˜¯ BitTorrentï¼ˆæ¯”ç‰¹æ´ªæµï¼‰çš„ç®€ç§°ã€‚BitTorrent æ˜¯ä¸€ç§ P2Pï¼ˆpeer-to-peerï¼‰åè®®ï¼ŒBitTorrent ç½‘ç»œä¸­çš„ç”¨æˆ·è¢«ç§°ä½œ peerï¼Œæ¯ä¸ª peer éƒ½æ˜¯å‘åˆ«çš„ peer è¯·æ±‚èµ„æºï¼Œå³ peer åœ¨ä¸‹è½½çš„åŒæ—¶ä¹Ÿæ‹¥æœ‰ä¸Šä¼ çš„èƒ½åŠ›ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ç”¨æˆ·è¶Šå¤šï¼Œä¸‹è½½åŒä¸€æ–‡ä»¶çš„äººè¶Šå¤šï¼Œä¸‹è½½è¯¥æ–‡ä»¶çš„é€Ÿåº¦è¶Šå¿«ï¼Œä¸ä¼ ç»Ÿçš„C/Sæ¨¡å¼ä¸­æ‰€æœ‰çš„ç”¨æˆ·åªèƒ½å‘åŒä¸€ä¸ªæœåŠ¡å™¨è¯·æ±‚èµ„æºæ˜æ˜¾ä¸åŒã€‚</p>
<h2 id="è·å–-peers">è·å– Peers<a hidden class="anchor" aria-hidden="true" href="#è·å–-peers">#</a></h2>
<p>ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ€ä¹ˆå‘ç°åˆ«çš„ peersï¼Œè¿™å°±æ˜¯ tracker çš„ä½œç”¨ï¼Œæ ¹æ®<a href="https://zh.wikipedia.org/wiki/BitTorrent_(%E5%8D%8F%E8%AE%AE)">ç»´åŸºç™¾ç§‘</a>å®šä¹‰ï¼Œtracker æ˜¯æ”¶é›†ä¸‹è½½è€…ä¿¡æ¯çš„æœåŠ¡å™¨ï¼Œå¹¶å°†æ­¤ä¿¡æ¯æä¾›ç»™å…¶ä»–ä¸‹è½½è€…ï¼Œä½¿ä¸‹è½½è€…ä»¬ç›¸äº’è¿æ¥èµ·æ¥ï¼Œä¼ è¾“æ•°æ®ã€‚é‚£ä¹ˆ tracker åˆåœ¨å“ªå‘¢ï¼Ÿè¿™å°±æ˜¯ .torrent æ–‡ä»¶çš„ä½œç”¨ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æŠŠ .torrent æ–‡ä»¶å«åšç§å­æ–‡ä»¶ï¼Œä½†å…¶å® torrent çš„ä¸­æ–‡æ„æ€æ˜¯æ´ªæµï¼ŒæŠŠé€šè¿‡ä¸€ä¸ª tracker æœåŠ¡å™¨è¿æ¥èµ·æ¥çš„ peers ç½‘ç»œç§°ä½œä¸€ä¸ªæ´ªæµï¼Œè¿˜æŒºå½¢è±¡çš„ã€‚</p>
<h3 id="è§£æ-torrent-æ–‡ä»¶">è§£æ .torrent æ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#è§£æ-torrent-æ–‡ä»¶">#</a></h3>
<p>.torrent æ–‡ä»¶ä½¿ç”¨ <strong>Bencode</strong>ï¼ˆå‘éŸ³ä¸ºÂ <em>bee-encode</em>ï¼‰è¿›è¡Œäº†ç¼–ç ã€‚Bencode ä½¿ç”¨ ASCII å­—ç¬¦è¿›è¡Œç¼–ç ï¼š</p>
<ul>
<li>
<p>Integer ç¼–ç ä¸º <strong>i</strong>&lt;10è¿›åˆ¶ç¼–ç æ•´æ•°&gt;<strong>e</strong>ï¼Œå¦‚ i7e è¡¨ç¤ºæ•´æ•° 7</p>
</li>
<li>
<p>Byte string ç¼–ç ä¸º <length>:<string data>ï¼Œå¦‚ 4:spam è¡¨ç¤ºå­—ç¬¦ä¸² &ldquo;spam&rdquo;</p>
</li>
<li>
<p>List ç¼–ç ä¸º <strong>l</strong><bencoded values><strong>e</strong>ï¼Œå¦‚ l4:spam4:eggse è¡¨ç¤º <code>[&quot;spam&quot;, &quot;eggs&quot;]</code>ï¼Œlist å¯ä»¥åŒ…å«ä»»ä½•å…¶ä»–ç±»å‹çš„ bencoded value</p>
</li>
<li>
<p>Dictionary ç¼–ç ä¸º <strong>d</strong><bencoded string><bencoded element><strong>e</strong>ï¼Œå¦‚ d3:cow3:moo4:spam4:eggse è¡¨ç¤ºå­—å…¸ï¼š<code>{ &quot;cow&quot; : &quot;moo&quot;, &quot;spam&quot; : &quot;eggs&quot; }</code></p>
</li>
</ul>
<p>å¦‚æ–‡ä»¶ debian-11.4.0-amd64-netinst.iso.torrent çš„å†…å®¹ä¸ºï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>d8:announce41:http://bttracker.debian.org:6969/announce7:comment35:&#34;Debian CD from cdimage.debian.org&#34;13:creation datei1657367679e9:httpseedsl145:https://cdimage.debian.org/cdimage/release/11.4.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-11.4.0-amd64-netinst.iso145:https://cdimage.debian.org/cdimage/archive/11.4.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-11.4.0-amd64-netinst.isoe4:infod6:lengthi397410304e4:name31:debian-11.4.0-amd64-netinst.iso12:piece lengthi262144e6:pieces30320:(binary blob of the hashes of each piece)
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŠŠå®ƒè½¬æ¢æˆæ›´å¥½çœ‹çš„å½¢å¼ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>d
</span></span><span style="display:flex;"><span>  8:announce
</span></span><span style="display:flex;"><span>    41:http://bttracker.debian.org:6969/announce
</span></span><span style="display:flex;"><span>  7:comment
</span></span><span style="display:flex;"><span>    35:&#34;Debian CD from cdimage.debian.org&#34;
</span></span><span style="display:flex;"><span>  13:creation date
</span></span><span style="display:flex;"><span>    i1657367679e
</span></span><span style="display:flex;"><span>  9:httpseeds
</span></span><span style="display:flex;"><span>Â Â Â Â l
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â 145:https://cdimage.debian.org/cdimage/release/11.4.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-11.4.0-amd64-netinst.iso
</span></span><span style="display:flex;"><span>Â Â Â Â Â Â Â Â 145:https://cdimage.debian.org/cdimage/archive/11.4.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-11.4.0-amd64-netinst.iso
</span></span><span style="display:flex;"><span>Â Â Â Â e
</span></span><span style="display:flex;"><span>  4:info
</span></span><span style="display:flex;"><span>    d
</span></span><span style="display:flex;"><span>      6:length
</span></span><span style="display:flex;"><span>        i351272960e
</span></span><span style="display:flex;"><span>      4:name
</span></span><span style="display:flex;"><span>        31:debian-10.2.0-amd64-netinst.iso
</span></span><span style="display:flex;"><span>      12:piece length
</span></span><span style="display:flex;"><span>        i262144e
</span></span><span style="display:flex;"><span>      6:pieces
</span></span><span style="display:flex;"><span>        26800:ï¿½ï¿½ï¿½ï¿½ï¿½PSï¿½^ï¿½ï¿½ (binary blob of the hashes of each piece)
</span></span><span style="display:flex;"><span>    e
</span></span><span style="display:flex;"><span>e
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªæ–‡ä»¶ä¸­åŒ…æ‹¬ tracker çš„ URLã€åˆ›å»ºæ—¶é—´ã€æ–‡ä»¶çš„å¤§å°å’Œåç§°ã€piece çš„å¤§å°ä»¥åŠæ‰€æœ‰ piece çš„ SHA-1 å“ˆå¸Œå€¼çš„ BLOB ï¼ˆbinary large objectï¼‰ã€‚httpseeds å­—æ®µæ˜¯åç»­ä¸ºäº†æ”¯æŒé€šè¿‡ HTTP åè®®åˆ†å‘æ•°æ®çš„æ‹“å±•ï¼Œæœ¬æ–‡ä¸ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œå¯ä»¥ç›´æ¥å¿½ç•¥ã€‚</p>
<h4 id="å®ç°-bencodeè§£æå™¨">å®ç° BencodeÂ è§£æå™¨<a hidden class="anchor" aria-hidden="true" href="#å®ç°-bencodeè§£æå™¨">#</a></h4>
<p>æ‰€ä»¥è¦è§£æ .torrent æ–‡ä»¶å°±éœ€è¦ä¸€ä¸ª bencode è§£æå™¨ï¼Œç½‘ä¸Šå·²ç»æœ‰ç°æˆçš„äº†ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰å†™è¿‡è¿™ç§è§£æå™¨ï¼Œæ‰€ä»¥å°±å‚è€ƒ<a href="https://github.com/archeryue/go-torrent">è¿™ä¸ª</a>é¡¹ç›®å†™äº†ä¸€ä¸ªã€‚</p>
<p>é¦–å…ˆå®šä¹‰ä»¥ä¸‹å†…å®¹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">type</span> BType <span style="color:#fff;font-weight:bold">uint8</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">type</span> BVal <span style="color:#fff;font-weight:bold">interface</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">const</span> (
</span></span><span style="display:flex;"><span>    BINT BType = <span style="color:#fff;font-weight:bold">iota</span>
</span></span><span style="display:flex;"><span>    BSTR
</span></span><span style="display:flex;"><span>    BLIST
</span></span><span style="display:flex;"><span>    BDICT
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">type</span> BObj <span style="color:#fff;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>    type_ BType
</span></span><span style="display:flex;"><span>    val_  BVal
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŠŠä»»æ„ bencode ç¼–ç çš„å¯¹è±¡è¡¨ç¤ºä¸ºä¸€ä¸ª BObjï¼Œå®ƒæœ‰ç±»å‹å’Œå€¼ä¸¤ä¸ªå­—æ®µï¼Œåˆå› ä¸ºå…·ä½“å€¼çš„ç±»å‹æ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥ä½¿ç”¨ç©ºæ¥å£ç±»å‹ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> Decode(r io.Reader) (*BObj, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>    br, ok := r.(*bufio.Reader)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> !ok {
</span></span><span style="display:flex;"><span>        br = bufio.NewReader(r)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    b, err := br.Peek(<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">switch</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> b[<span style="color:#ff0;font-weight:bold">0</span>] &gt;= <span style="color:#0ff;font-weight:bold">&#39;0&#39;</span> &amp;&amp; b[<span style="color:#ff0;font-weight:bold">0</span>] &lt;= <span style="color:#0ff;font-weight:bold">&#39;9&#39;</span>:
</span></span><span style="display:flex;"><span>        s, err := DecodeString(br)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> NewBObj(BSTR, s), <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> b[<span style="color:#ff0;font-weight:bold">0</span>] == <span style="color:#0ff;font-weight:bold">&#39;i&#39;</span>:
</span></span><span style="display:flex;"><span>        num, err := DecodeInt(br)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> NewBObj(BINT, num), <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> b[<span style="color:#ff0;font-weight:bold">0</span>] == <span style="color:#0ff;font-weight:bold">&#39;l&#39;</span>:
</span></span><span style="display:flex;"><span>        br.ReadByte() <span style="color:#007f7f">// start l
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">var</span> list []*BObj
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>            b, err := br.Peek(<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> b[<span style="color:#ff0;font-weight:bold">0</span>] == <span style="color:#0ff;font-weight:bold">&#39;e&#39;</span> { <span style="color:#007f7f">// end e
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                br.ReadByte()
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> NewBObj(BLIST, list), <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            bobj, err := Decode(br)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            list = <span style="color:#fff;font-weight:bold">append</span>(list, bobj)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> b[<span style="color:#ff0;font-weight:bold">0</span>] == <span style="color:#0ff;font-weight:bold">&#39;d&#39;</span>:
</span></span><span style="display:flex;"><span>        br.ReadByte() <span style="color:#007f7f">// start d
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        dict := <span style="color:#fff;font-weight:bold">map</span>[<span style="color:#fff;font-weight:bold">string</span>]*BObj{}
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> {
</span></span><span style="display:flex;"><span>            b, err := br.Peek(<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> b[<span style="color:#ff0;font-weight:bold">0</span>] == <span style="color:#0ff;font-weight:bold">&#39;e&#39;</span> { <span style="color:#007f7f">// end e
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                br.ReadByte()
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> NewBObj(BDICT, dict), <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            key, err := DecodeString(br)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            bobj, err := Decode(br)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">nil</span>, err
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            dict[key] = bobj
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">nil</span>, ErrIvd
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§£ç å‡½æ•°æ€è·¯æ˜¯é¦–å…ˆæ ¹æ®å¼€å¤´åˆ¤æ–­æ•°æ®ç±»å‹ï¼Œç„¶åå»è§£æï¼Œå¦‚æœæ˜¯ List æˆ– Dictionary ç±»å‹ç›´æ¥å¾ªç¯é€’å½’å¤„ç†å°±è¡Œäº†ï¼Œåœ¨å¾ªç¯ä¸­æ£€æŸ¥ä¸‹ä¸€ä¸ªå¾…è¯»å–çš„å­—ç¬¦æ˜¯ä¸æ˜¯ &rsquo;e&rsquo; ï¼Œå¦‚æœæ˜¯çš„è¯é‚£ä¹ˆä¸€å®šæ˜¯è¯¥ BObj æœ€åä¸€ä¸ª &rsquo;e&rsquo;ï¼Œå› ä¸ºå®ƒåµŒå¥—çš„ BObj ä¸€å®šä¼šæŠŠå‰é¢çš„ &rsquo;e&rsquo;ï¼ˆå¦‚æœæœ‰çš„è¯ï¼Œå½“åµŒå¥—äº† List å’Œ Dictionary å’Œ Integer ç±»å‹æ—¶ä¼šæœ‰ï¼‰è¯»å–å‡ºæ¥ ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> (o *BObj) Encode(w io.Writer) (<span style="color:#fff;font-weight:bold">int</span>, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>    bw, ok := w.(*bufio.Writer)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> !ok {
</span></span><span style="display:flex;"><span>        bw = bufio.NewWriter(w)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    curLen := <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">switch</span> o.type_ {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> BINT:
</span></span><span style="display:flex;"><span>        num, _ := o.Int()
</span></span><span style="display:flex;"><span>        wLen, err := EncodeInt(bw, num)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        curLen += wLen
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> BSTR:
</span></span><span style="display:flex;"><span>        s, _ := o.Str()
</span></span><span style="display:flex;"><span>        wLen, err := EncodeStr(bw, s)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        curLen += wLen
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> BLIST:
</span></span><span style="display:flex;"><span>        list, _ := o.List()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        curLen += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        bw.WriteByte(<span style="color:#0ff;font-weight:bold">&#39;l&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> _, bobj := <span style="color:#fff;font-weight:bold">range</span> list {
</span></span><span style="display:flex;"><span>            wLen, err := bobj.Encode(bw)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>, err
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            curLen += wLen
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        curLen += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        bw.WriteByte(<span style="color:#0ff;font-weight:bold">&#39;e&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> BDICT:
</span></span><span style="display:flex;"><span>        dict, _ := o.Dict()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        curLen += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        bw.WriteByte(<span style="color:#0ff;font-weight:bold">&#39;d&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> key, bobj := <span style="color:#fff;font-weight:bold">range</span> dict {
</span></span><span style="display:flex;"><span>            wLen, err := EncodeStr(bw, key)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>, err
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            curLen += wLen
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            wLen, err = bobj.Encode(bw)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>, err
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            curLen += wLen
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        curLen += <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        bw.WriteByte(<span style="color:#0ff;font-weight:bold">&#39;e&#39;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err := bw.Flush(); err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> curLen, <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¼–ç å‡½æ•°æ€è·¯å’Œè§£ç å‡½æ•°å·®ä¸å¤šï¼Œç›´æ¥åˆ¤æ–­ BObj çš„ç±»å‹ç„¶åå»ç¼–ç ï¼Œå¦‚æœæ˜¯ List æˆ– Dictionary ç±»å‹åŒæ ·å»å¾ªç¯é€’å½’å¤„ç†ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> Unmarshal(r io.Reader, s <span style="color:#fff;font-weight:bold">interface</span>{}) <span style="color:#fff;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>    o, err := Decode(r)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    v := reflect.ValueOf(s)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> v.Kind() != reflect.Ptr {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> errors.New(<span style="color:#0ff;font-weight:bold">&#34;dst must be a pointer&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">switch</span> o.type_ {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> BLIST:
</span></span><span style="display:flex;"><span>        list, _ := o.List()
</span></span><span style="display:flex;"><span>        l := reflect.MakeSlice(v.Elem().Type(), <span style="color:#fff;font-weight:bold">len</span>(list), <span style="color:#fff;font-weight:bold">len</span>(list))
</span></span><span style="display:flex;"><span>        v.Elem().Set(l)
</span></span><span style="display:flex;"><span>        err = unmarshalList(list, v)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> BDICT:
</span></span><span style="display:flex;"><span>        dict, _ := o.Dict()
</span></span><span style="display:flex;"><span>        err := unmarshalDict(dict, v)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">default</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> errors.New(<span style="color:#0ff;font-weight:bold">&#34;src must be struct or slice&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Unmarshal</code> å‡½æ•°é¦–å…ˆåˆ©ç”¨ä¹‹å‰çš„è§£ç å‡½æ•°å¾—åˆ°ä¸€ä¸ª BObjï¼Œ ç„¶ååˆ©ç”¨è¿™ä¸ª BObj å»ååºåˆ—åŒ–ã€‚ååºåˆ—åŒ–çš„ç›®æ ‡åªèƒ½æ˜¯åˆ‡ç‰‡æˆ–è€…ç»“æ„ä½“ç±»å‹ï¼Œè¾“å…¥æ˜¯å®ƒä»¬çš„æŒ‡é’ˆã€‚å¦‚æœæ˜¯ List çš„è¯è¦å…ˆåˆ©ç”¨åå°„æŠŠåˆ‡ç‰‡çš„é•¿åº¦è®¾ç½®å¥½ã€‚é‡ç‚¹æ˜¯ <code>unmarshalList</code> å’Œ <code>UnmarshalDict</code> è¿™ä¸¤ä¸ªå‡½æ•°ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> unmarshalList(list []*BObj, v reflect.Value) <span style="color:#fff;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> v.Kind() != reflect.Ptr || v.Elem().Kind() != reflect.Slice {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> errors.New(<span style="color:#0ff;font-weight:bold">&#34;dst must be pointer of slice&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    v = v.Elem()
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">len</span>(list) == <span style="color:#ff0;font-weight:bold">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">switch</span> list[<span style="color:#ff0;font-weight:bold">0</span>].type_ {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> BSTR:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> i, bObj := <span style="color:#fff;font-weight:bold">range</span> list {
</span></span><span style="display:flex;"><span>            s, err := bObj.Str()
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            v.Index(i).SetString(s)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> BINT:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> i, bObj := <span style="color:#fff;font-weight:bold">range</span> list {
</span></span><span style="display:flex;"><span>            num, err := bObj.Int()
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            v.Index(i).SetInt(<span style="color:#fff;font-weight:bold">int64</span>(num))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> BLIST:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> v.Type().Elem().Kind() != reflect.Slice {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> ErrTyp
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> i, bObj := <span style="color:#fff;font-weight:bold">range</span> list {
</span></span><span style="display:flex;"><span>            bList, err := bObj.List()
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            newPtr := reflect.New(v.Type().Elem())
</span></span><span style="display:flex;"><span>            newSlice := reflect.MakeSlice(v.Type().Elem(), <span style="color:#fff;font-weight:bold">len</span>(bList), <span style="color:#fff;font-weight:bold">len</span>(bList))
</span></span><span style="display:flex;"><span>            newPtr.Elem().Set(newSlice)
</span></span><span style="display:flex;"><span>            err = unmarshalList(bList, newPtr)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            v.Index(i).Set(newPtr.Elem())
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> BDICT:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> v.Type().Elem().Kind() != reflect.Struct {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> ErrTyp
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> i, bObj := <span style="color:#fff;font-weight:bold">range</span> list {
</span></span><span style="display:flex;"><span>            bDict, err := bObj.Dict()
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            newPtr := reflect.New(v.Type().Elem())
</span></span><span style="display:flex;"><span>            err = unmarshalDict(bDict, newPtr)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            v.Index(i).Set(newPtr.Elem())
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>unmarshalList</code> å‡½æ•°é¦–å…ˆåˆ¤æ–­è¾“å…¥çš„ <code>v</code> åªèƒ½æ˜¯åˆ‡ç‰‡çš„æŒ‡é’ˆç±»å‹ï¼Œè¦ä¸ç„¶ä¸èƒ½ Setã€‚è¾“å…¥ list ä¸­çš„å…ƒç´ çš„ç±»å‹è‚¯å®šéƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¯¹åº”åˆ‡ç‰‡ä¸­å…ƒç´ çš„ç±»å‹ï¼Œæ‰€ä»¥åªåˆ¤æ–­ç¬¬ä¸€ä¸ªå…ƒç´ çš„ç±»å‹å°±å¯ä»¥äº†ï¼Œç„¶åå»å¾ªç¯è®¾ç½®æ¯ä¸€ä¸ªä½ç½®çš„å…ƒç´ ã€‚æ•´æ•°å’Œå­—ç¬¦ä¸²çš„æƒ…å†µæ¯”è¾ƒç®€å•ï¼Œä¸å†èµ˜è¿°ã€‚</p>
<p>å¯¹äº <code>BLIST</code> ç±»å‹ï¼Œå…ˆåˆ¤æ–­è¾“å…¥ <code>v</code> çš„ç±»å‹çš„çš„åŸºæœ¬å…ƒç´ ï¼ˆ<code>v.Type().Elem()</code> çš„è¿”å›å€¼ä¹Ÿæ˜¯ <code>reflect.Type</code> ç±»å‹ï¼ŒæŒ‡çš„æ˜¯å½“å‰ç±»å‹çš„åŸºæœ¬å…ƒç´ ç±»å‹ï¼Œåªé’ˆå¯¹æŒ‡é’ˆã€æ•°ç»„ã€åˆ‡ç‰‡ã€æ˜ å°„ã€é€šé“ç±»å‹æ‰æ˜¯æœ‰æ•ˆçš„ï¼Œè¦å’Œ <code>v.Elem()</code> åŒºåˆ†å¼€ï¼Œè¯¥å‡½æ•°çš„è¿”å›å€¼ç±»å‹æ˜¯ <code>reflect.Value</code>ï¼Œåªé’ˆå¯¹æŒ‡é’ˆå’Œæ¥å£ç±»å‹æ‰æœ‰æ•ˆï¼ŒæŒ‡çš„å°±æ˜¯ <code>v</code> æŒ‡å‘çš„å€¼ï¼‰ä¹Ÿæ˜¯åˆ‡ç‰‡ç±»å‹æ‰å¯ä»¥æ­£ç¡®è¿›è¡Œååºåˆ—åŒ–ã€‚åˆ¤æ–­å®Œæˆä¹‹åå†å»å¾ªç¯è®¾ç½®ï¼Œæ¯ä¸€æ¬¡å¾ªç¯éƒ½å…ˆè·å–åˆ°å½“å‰ä½ç½®å¯¹åº”çš„ <code>bList</code> ç„¶ååˆ›å»ºä¸€ä¸ªåˆ‡ç‰‡çš„æŒ‡é’ˆï¼Œè®¾ç½®å…¶é•¿åº¦å’Œå®¹é‡ï¼Œå†è¿›è¡Œé€’å½’å¤„ç†ã€‚æœ€åè®¾ç½®è¯¥ä½ç½®çš„å…ƒç´ ã€‚</p>
<p>å¯¹äº <code>BDICT</code> ç±»å‹ï¼Œè¿‡ç¨‹å’Œ <code>BLIST</code> ç±»å‹ç±»ä¼¼ã€‚<code>unmarshalDict</code> å‡½æ•°å’Œ <code>unmarshalList</code> åŸºæœ¬ä¸€è‡´ï¼Œåªä¸è¿‡å› ä¸ºæ¯ä¸€ä¸ªå­—æ®µçš„ç±»å‹å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥è¦åœ¨æ¯ä¸€æ¬¡å¾ªç¯é‡Œé¢åˆ¤æ–­ç±»å‹ã€‚å¦å¤–å°±æ˜¯ tag çš„å¤„ç†ï¼Œè¿‡ç¨‹ä¹Ÿæ¯”è¾ƒç®€å•ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>fieldType := v.Type().Field(i)
</span></span><span style="display:flex;"><span>key := fieldType.Tag.Get(<span style="color:#0ff;font-weight:bold">&#34;bencode&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> key == <span style="color:#0ff;font-weight:bold">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>    key = strings.ToLower(fieldType.Name)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bObj, ok := bDict[key]
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Marshal</code> å‡½æ•°å°±æ¯”è¾ƒç®€å•äº†ï¼Œç›´æ¥åˆ¤æ–­å½“å‰å€¼çš„ç±»å‹ç„¶åå»ç¼–ç å°±è¡Œäº†ï¼Œè¿‡ç¨‹è·Ÿç¼–ç å‡½æ•°åŸºæœ¬ä¸€è‡´ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">84
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">85
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">86
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">87
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">88
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">89
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">90
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">91
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">92
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> Marshal(w io.Writer, i <span style="color:#fff;font-weight:bold">interface</span>{}) (<span style="color:#fff;font-weight:bold">int</span>, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>    v := reflect.ValueOf(i)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> v.Kind() == reflect.Ptr {
</span></span><span style="display:flex;"><span>        v = v.Elem()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> marshalValue(w, v)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> marshalValue(w io.Writer, v reflect.Value) (<span style="color:#fff;font-weight:bold">int</span>, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>    curLen := <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">switch</span> v.Kind() {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> reflect.Int:
</span></span><span style="display:flex;"><span>        wLen, err := EncodeInt(w, <span style="color:#fff;font-weight:bold">int</span>(v.Int()))
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        curLen += wLen
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> reflect.String:
</span></span><span style="display:flex;"><span>        wLen, err := EncodeStr(w, v.String())
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        curLen += wLen
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> reflect.Slice:
</span></span><span style="display:flex;"><span>        wLen, err := marshalList(w, v)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        curLen += wLen
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">case</span> reflect.Struct:
</span></span><span style="display:flex;"><span>        wLen, err := marshalDict(w, v)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        curLen += wLen
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">default</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>, errors.New(<span style="color:#0ff;font-weight:bold">&#34;unsupported type&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> curLen, <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> marshalList(w io.Writer, v reflect.Value) (<span style="color:#fff;font-weight:bold">int</span>, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>    curLen := <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    w.Write([]<span style="color:#fff;font-weight:bold">byte</span>{<span style="color:#0ff;font-weight:bold">&#39;l&#39;</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i := <span style="color:#ff0;font-weight:bold">0</span>; i &lt; v.Len(); i++ {
</span></span><span style="display:flex;"><span>        curV := v.Index(i)
</span></span><span style="display:flex;"><span>        wLen, err := marshalValue(w, curV)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        curLen += wLen
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    w.Write([]<span style="color:#fff;font-weight:bold">byte</span>{<span style="color:#0ff;font-weight:bold">&#39;e&#39;</span>})
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> curLen + <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> marshalDict(w io.Writer, v reflect.Value) (<span style="color:#fff;font-weight:bold">int</span>, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>    curLen := <span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    w.Write([]<span style="color:#fff;font-weight:bold">byte</span>{<span style="color:#0ff;font-weight:bold">&#39;d&#39;</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">for</span> i := <span style="color:#ff0;font-weight:bold">0</span>; i &lt; v.NumField(); i++ {
</span></span><span style="display:flex;"><span>        field := v.Field(i)
</span></span><span style="display:flex;"><span>        fieldType := v.Type().Field(i)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        key := fieldType.Tag.Get(<span style="color:#0ff;font-weight:bold">&#34;bencode&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> key == <span style="color:#0ff;font-weight:bold">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>            key = strings.ToLower(fieldType.Name)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        wLen, err := EncodeStr(w, key)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        curLen += wLen
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        wLen, err = marshalValue(w, field)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        curLen += wLen
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    w.Write([]<span style="color:#fff;font-weight:bold">byte</span>{<span style="color:#0ff;font-weight:bold">&#39;e&#39;</span>})
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> curLen + <span style="color:#ff0;font-weight:bold">1</span>, <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ä½¿ç”¨-bencode-è§£æå™¨è§£æ-torrent-æ–‡ä»¶">ä½¿ç”¨ bencode è§£æå™¨è§£æ .torrent æ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨-bencode-è§£æå™¨è§£æ-torrent-æ–‡ä»¶">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">type</span> Info <span style="color:#fff;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>    Length      <span style="color:#fff;font-weight:bold">int</span>    <span style="color:#0ff;font-weight:bold">`bencode:&#34;length&#34;`</span>
</span></span><span style="display:flex;"><span>    Name        <span style="color:#fff;font-weight:bold">string</span> <span style="color:#0ff;font-weight:bold">`bencode:&#34;name&#34;`</span>
</span></span><span style="display:flex;"><span>    PieceLength <span style="color:#fff;font-weight:bold">int</span>    <span style="color:#0ff;font-weight:bold">`bencode:&#34;piece length&#34;`</span>
</span></span><span style="display:flex;"><span>    Pieces      <span style="color:#fff;font-weight:bold">string</span> <span style="color:#0ff;font-weight:bold">`bencode:&#34;pieces&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">type</span> TorrentFile <span style="color:#fff;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>    Announce <span style="color:#fff;font-weight:bold">string</span> <span style="color:#0ff;font-weight:bold">`bencode:&#34;announce&#34;`</span>
</span></span><span style="display:flex;"><span>    Info     Info   <span style="color:#0ff;font-weight:bold">`bencode:&#34;info&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">var</span> tf torrentfile.TorrentFile
</span></span><span style="display:flex;"><span>file, _ := os.Open(<span style="color:#0ff;font-weight:bold">&#34;xxx.torrent&#34;</span>)
</span></span><span style="display:flex;"><span>err := bencode.Unmarshal(file, &amp;tf)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>    log.Fatalln(<span style="color:#0ff;font-weight:bold">&#34;invalid torrent file&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»¥ä¸Šå°±å®Œæˆäº† .torrent æ–‡ä»¶çš„è§£æ</p>
<h3 id="ä»-tracker-è·å–-peers">ä» tracker è·å– peers<a hidden class="anchor" aria-hidden="true" href="#ä»-tracker-è·å–-peers">#</a></h3>
<p>é¦–å…ˆå®šä¹‰ä¸€ä¸ªæ–°çš„ç»“æ„ä½“ï¼Œä¸åºåˆ—åŒ–ç»“æ„ä½“åŒºåˆ†å¼€ï¼Œä½œä¸ºåº”ç”¨ç»“æ„ä½“ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">type</span> Torrent <span style="color:#fff;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>    Announce    <span style="color:#fff;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    Name        <span style="color:#fff;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    Length      <span style="color:#fff;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>    InfoHash    [<span style="color:#ff0;font-weight:bold">20</span>]<span style="color:#fff;font-weight:bold">byte</span>
</span></span><span style="display:flex;"><span>    PieceLength <span style="color:#fff;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>    PieceHashes [][<span style="color:#ff0;font-weight:bold">20</span>]<span style="color:#fff;font-weight:bold">byte</span>
</span></span><span style="display:flex;"><span>    Peers       []peer.Peer
</span></span><span style="display:flex;"><span>    PeerID      [<span style="color:#ff0;font-weight:bold">20</span>]<span style="color:#fff;font-weight:bold">byte</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>TorrentFile</code> å®ç°å‘ <code>Torrent</code> è½¬æ¢çš„æ–¹æ³• <code>ToTorrent</code>ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> (i *Info) Hash() ([<span style="color:#ff0;font-weight:bold">20</span>]<span style="color:#fff;font-weight:bold">byte</span>, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">var</span> buf bytes.Buffer
</span></span><span style="display:flex;"><span>	_, err := bencode.Marshal(&amp;buf, *i)
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> [<span style="color:#ff0;font-weight:bold">20</span>]<span style="color:#fff;font-weight:bold">byte</span>{}, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	h := sha1.Sum(buf.Bytes())
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">return</span> h, <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> (i *Info) splitPieceHashes() ([][<span style="color:#ff0;font-weight:bold">20</span>]<span style="color:#fff;font-weight:bold">byte</span>, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	hashLen := <span style="color:#ff0;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>	buf := []<span style="color:#fff;font-weight:bold">byte</span>(i.Pieces)
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">len</span>(buf)%hashLen != <span style="color:#ff0;font-weight:bold">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">nil</span>, fmt.Errorf(<span style="color:#0ff;font-weight:bold">&#34;malformed pieces hash length: %d&#34;</span>, <span style="color:#fff;font-weight:bold">len</span>(buf))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	numHashes := <span style="color:#fff;font-weight:bold">len</span>(buf) / hashLen
</span></span><span style="display:flex;"><span>	hashes := <span style="color:#fff;font-weight:bold">make</span>([][<span style="color:#ff0;font-weight:bold">20</span>]<span style="color:#fff;font-weight:bold">byte</span>, numHashes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">for</span> i := <span style="color:#ff0;font-weight:bold">0</span>; i &lt; numHashes; i++ {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">copy</span>(hashes[i][:], buf[i*hashLen:(i+<span style="color:#ff0;font-weight:bold">1</span>)*hashLen])
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">return</span> hashes, <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> (tf *TorrentFile) ToTorrent() (torrent.Torrent, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	infoHash, err := tf.Info.Hash()
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> torrent.Torrent{}, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	pieceHashes, err := tf.Info.splitPieceHashes()
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> torrent.Torrent{}, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">return</span> torrent.Torrent{
</span></span><span style="display:flex;"><span>		Announce:    tf.Announce,
</span></span><span style="display:flex;"><span>		Name:        tf.Info.Name,
</span></span><span style="display:flex;"><span>		Length:      tf.Info.Length,
</span></span><span style="display:flex;"><span>		InfoHash:    infoHash,
</span></span><span style="display:flex;"><span>		PieceLength: tf.Info.PieceLength,
</span></span><span style="display:flex;"><span>		PieceHashes: pieceHashes,
</span></span><span style="display:flex;"><span>	}, <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Torrent</code> è·å– Peers çš„æ–¹æ³•ä¸ºï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">type</span> TrackerResp <span style="color:#fff;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	Interval <span style="color:#fff;font-weight:bold">int</span>    <span style="color:#0ff;font-weight:bold">`bencode:&#34;interval&#34;`</span>
</span></span><span style="display:flex;"><span>	Peers    <span style="color:#fff;font-weight:bold">string</span> <span style="color:#0ff;font-weight:bold">`bencode:&#34;peers&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> (t *Torrent) buildTrackerURL(peerID [<span style="color:#ff0;font-weight:bold">20</span>]<span style="color:#fff;font-weight:bold">byte</span>, port <span style="color:#fff;font-weight:bold">uint16</span>) (<span style="color:#fff;font-weight:bold">string</span>, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	base, err := url.Parse(t.Announce)
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	params := url.Values{
</span></span><span style="display:flex;"><span>		<span style="color:#0ff;font-weight:bold">&#34;info_hash&#34;</span>:  []<span style="color:#fff;font-weight:bold">string</span>{<span style="color:#fff;font-weight:bold">string</span>(t.InfoHash[:])},
</span></span><span style="display:flex;"><span>		<span style="color:#0ff;font-weight:bold">&#34;peer_id&#34;</span>:    []<span style="color:#fff;font-weight:bold">string</span>{<span style="color:#fff;font-weight:bold">string</span>(peerID[:])},
</span></span><span style="display:flex;"><span>		<span style="color:#0ff;font-weight:bold">&#34;port&#34;</span>:       []<span style="color:#fff;font-weight:bold">string</span>{strconv.Itoa(<span style="color:#fff;font-weight:bold">int</span>(Port))},
</span></span><span style="display:flex;"><span>		<span style="color:#0ff;font-weight:bold">&#34;uploaded&#34;</span>:   []<span style="color:#fff;font-weight:bold">string</span>{<span style="color:#0ff;font-weight:bold">&#34;0&#34;</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#0ff;font-weight:bold">&#34;downloaded&#34;</span>: []<span style="color:#fff;font-weight:bold">string</span>{<span style="color:#0ff;font-weight:bold">&#34;0&#34;</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#0ff;font-weight:bold">&#34;compact&#34;</span>:    []<span style="color:#fff;font-weight:bold">string</span>{<span style="color:#0ff;font-weight:bold">&#34;1&#34;</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#0ff;font-weight:bold">&#34;left&#34;</span>:       []<span style="color:#fff;font-weight:bold">string</span>{strconv.Itoa(t.Length)},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	base.RawQuery = params.Encode()
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">return</span> base.String(), <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> (t *Torrent) GetPeers() <span style="color:#fff;font-weight:bold">error</span> {
</span></span><span style="display:flex;"><span>	_, err := rand.Read(t.PeerID[:])
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	url, err := t.buildTrackerURL(t.PeerID, <span style="color:#fff;font-weight:bold">uint16</span>(Port))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	c := &amp;http.Client{Timeout: <span style="color:#ff0;font-weight:bold">15</span> * time.Second}
</span></span><span style="display:flex;"><span>	resp, err := c.Get(url)
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">defer</span> resp.Body.Close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	res, err := io.ReadAll(resp.Body)
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">var</span> tr TrackerResp
</span></span><span style="display:flex;"><span>	err = bencode.Unmarshal(bytes.NewBuffer(res), &amp;tr)
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	peers, err := peer.Unmarshal([]<span style="color:#fff;font-weight:bold">byte</span>(tr.Peers))
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">if</span> err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	t.Peers = peers
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨å‘ tracker è¯·æ±‚çš„å‚æ•°ä¸­ï¼š</p>
<ul>
<li>
<p>info_hashï¼š.torrent æ–‡ä»¶ä¸­ info éƒ¨åˆ†çš„ SHA-1 å“ˆå¸Œå€¼ï¼Œtracker ç”¨è¿™ä¸ªç¡®è®¤æƒ³è¦ä¸‹è½½å“ªä¸ªæ–‡ä»¶ï¼Œè¿™æ ·æ‰èƒ½ç¡®è®¤æ‹¥æœ‰è¿™ä¸ªæ–‡ä»¶çš„ peers</p>
</li>
<li>
<p>peer_idï¼šå®¢æˆ·ç«¯çš„ IDï¼Œå¦‚â€utorrent-xxxâ€œï¼Œæ ‡è¯†å®¢æˆ·ç«¯è½¯ä»¶å’Œç‰ˆæœ¬ï¼Œæœ¬æ–‡ç›´æ¥ç”¨éšæœºç”Ÿæˆçš„</p>
</li>
<li>
<p>portï¼šå®¢æˆ·ç«¯ç›‘å¬çš„ç«¯å£å·</p>
</li>
<li>
<p>uploadedï¼šæ€»ä¸Šä¼ é‡</p>
</li>
<li>
<p>downloadedï¼šæ€»ä¸‹è½½é‡</p>
</li>
<li>
<p>compactï¼šè®¾ä¸º 1 è¡¨ç¤ºä½¿ç”¨ç´§å‡‘æ¨¡å¼ï¼Œæ¯ä¸ª peer ç”¨å…­ä¸ªå­—èŠ‚è¡¨ç¤ºï¼Œå‰å››ä¸ªæ˜¯ IP åœ°å€åä¸¤ä¸ªæ˜¯ç«¯å£å·</p>
</li>
<li>
<p>leftï¼šå‰©ä½™ä¸‹è½½é‡</p>
</li>
</ul>
<p>Tracker å‘å›çš„å“åº”ä¹Ÿæ˜¯ bencode ç¼–ç çš„æ ¼å¼ï¼Œå¯ä»¥ç”¨ä¸Šæ–‡å®ç°çš„ bencode è§£æå™¨ç›´æ¥ååºåˆ—åŒ–å¾—åˆ° <code>TrackerResp</code> ç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸¤ä¸ªå­—æ®µï¼š<code>Interval</code> è¡¨ç¤ºåº”è¯¥éš”å¤šä¹…å†æ¬¡è¿æ¥åˆ° tracker æ¥æ›´æ–° peers åˆ—è¡¨ï¼Œ<code>Peers</code> æ˜¯ä¸€ä¸ªåŒ…å«ä¸Šæ–‡æåˆ°çš„ 6 å­—èŠ‚åœ°å€çš„ BLOBï¼Œå®šä¹‰ <code>Peer</code> ç»“æ„ä½“æ¥è§£æå®ƒï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">type</span> Peer <span style="color:#fff;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>	IP   net.IP
</span></span><span style="display:flex;"><span>	Port <span style="color:#fff;font-weight:bold">uint16</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> Unmarshal(peersBin []<span style="color:#fff;font-weight:bold">byte</span>) ([]Peer, <span style="color:#fff;font-weight:bold">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">const</span> peerSize = <span style="color:#ff0;font-weight:bold">6</span> <span style="color:#007f7f">// 4 for ip, 2 for port
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">len</span>(peersBin)%peerSize != <span style="color:#ff0;font-weight:bold">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">nil</span>, fmt.Errorf(<span style="color:#0ff;font-weight:bold">&#34;malformed binary peers length: %d&#34;</span>, <span style="color:#fff;font-weight:bold">len</span>(peersBin))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	numPeers := <span style="color:#fff;font-weight:bold">len</span>(peersBin) / peerSize
</span></span><span style="display:flex;"><span>	peers := <span style="color:#fff;font-weight:bold">make</span>([]Peer, numPeers)
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">for</span> i := <span style="color:#ff0;font-weight:bold">0</span>; i &lt; numPeers; i++ {
</span></span><span style="display:flex;"><span>		offset := i * peerSize
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">//peers[i].IP = net.IP(peersBin[offset : offset+4])
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		peers[i].IP = peersBin[offset : offset+<span style="color:#ff0;font-weight:bold">4</span>]
</span></span><span style="display:flex;"><span>		peers[i].Port = binary.BigEndian.Uint16(peersBin[offset+<span style="color:#ff0;font-weight:bold">4</span> : offset+<span style="color:#ff0;font-weight:bold">6</span>])
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">return</span> peers, <span style="color:#fff;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ°æ­¤ï¼Œå·²ç»è·å–åˆ°äº†æ‹¥æœ‰ .torrent ä¸­æ–‡ä»¶çš„ peersã€‚</p>

</div>
  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://tiandiyijian.top/tags/go/">Go</a></li>
    </ul>
    <nav class="paginav">
      <a class="next" href="https://tiandiyijian.top/posts/ultimate-go-programming-chap6/">
        <span class="title">Next Page Â»</span>
        <br>
        <span>Ultimate Go Programming ç¬”è®°â€”â€”ç¬¬å…­ç« </span>
      </a>
    </nav>






<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share Golang å®ç°BTä¸‹è½½å™¨ï¼ˆä¸€ï¼‰ on twitter"
        href="https://twitter.com/intent/tweet/?text=Golang%20%e5%ae%9e%e7%8e%b0BT%e4%b8%8b%e8%bd%bd%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89&amp;url=https%3a%2f%2ftiandiyijian.top%2fposts%2fgolang-bt%2f&amp;hashtags=Go">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Golang å®ç°BTä¸‹è½½å™¨ï¼ˆä¸€ï¼‰ on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2ftiandiyijian.top%2fposts%2fgolang-bt%2f&amp;title=Golang%20%e5%ae%9e%e7%8e%b0BT%e4%b8%8b%e8%bd%bd%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89&amp;summary=Golang%20%e5%ae%9e%e7%8e%b0BT%e4%b8%8b%e8%bd%bd%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89&amp;source=https%3a%2f%2ftiandiyijian.top%2fposts%2fgolang-bt%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Golang å®ç°BTä¸‹è½½å™¨ï¼ˆä¸€ï¼‰ on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2ftiandiyijian.top%2fposts%2fgolang-bt%2f&title=Golang%20%e5%ae%9e%e7%8e%b0BT%e4%b8%8b%e8%bd%bd%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Golang å®ç°BTä¸‹è½½å™¨ï¼ˆä¸€ï¼‰ on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ftiandiyijian.top%2fposts%2fgolang-bt%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Golang å®ç°BTä¸‹è½½å™¨ï¼ˆä¸€ï¼‰ on whatsapp"
        href="https://api.whatsapp.com/send?text=Golang%20%e5%ae%9e%e7%8e%b0BT%e4%b8%8b%e8%bd%bd%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89%20-%20https%3a%2f%2ftiandiyijian.top%2fposts%2fgolang-bt%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Golang å®ç°BTä¸‹è½½å™¨ï¼ˆä¸€ï¼‰ on telegram"
        href="https://telegram.me/share/url?text=Golang%20%e5%ae%9e%e7%8e%b0BT%e4%b8%8b%e8%bd%bd%e5%99%a8%ef%bc%88%e4%b8%80%ef%bc%89&amp;url=https%3a%2f%2ftiandiyijian.top%2fposts%2fgolang-bt%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
</div>

  </footer>
</article>
    </main><footer class="footer">
    <span>&copy; 2022 <a href="https://tiandiyijian.top">å¤©åœ°ä¸€é”®</a></span>
    <span>&middot;</span>
    <span>Powered by <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a></span>
    <span>&middot;</span>
    <span>Theme <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>



<script defer src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<script>
    window.onload = function () {
        if (localStorage.getItem("menu-scroll-position")) {
            document.getElementById('menu').scrollLeft = localStorage.getItem("menu-scroll-position");
        }
    }

    function menu_on_scroll() {
        localStorage.setItem("menu-scroll-position", document.getElementById('menu').scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

</body>

</html>
